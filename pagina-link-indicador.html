<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compartilhe e Ganhe</title>
</head>
<body>
  <h1>Compartilhe e Ganhe</h1>
  <p>Ganhe créditos indicando amigos!</p>
  <p>Você tem <span id="creditos">0</span> créditos.</p>

  <h3>Seu link de convite:</h3>
  <input type="text" id="linkConvite" readonly>
  <button onclick="copiarLink()">Copiar Link</button>

  <p>Convide amigos para atingir 100 créditos e desbloquear prêmios.</p>

  <script>
    // Substitua pela URL real do seu Web App do Google Apps Script
    const WEBAPP_URL = 'https://script.google.com/macros/s/[SEU_WEBAPP_ID]/exec';

    // Obtém usuário e ref da URL ou localStorage
    const urlParams = new URLSearchParams(window.location.search);
    const usuarioId = localStorage.getItem('usuario') || urlParams.get('usuario') || '';
    const ref = urlParams.get('ref') || '';

    // Gera o link de convite
    const linkConvite = `${window.location.origin}/r.html?ref=${encodeURIComponent(usuarioId)}`;
    document.getElementById('linkConvite').value = linkConvite;

    // Função para copiar o link
    function copiarLink() {
      const linkInput = document.getElementById('linkConvite');
      linkInput.select();
      document.execCommand('copy');
      alert('Link copiado para a área de transferência!');
    }

    // Verifica se usuarioId está definido
    if (!usuarioId) {
      alert('Erro: Nome de usuário não fornecido.');
      window.location.href = 'index.html';
      return;
    }

    // Faz a requisição para obter os créditos
    fetch(`${WEBAPP_URL}?usuario=${encodeURIComponent(usuarioId)}&ref=${encodeURIComponent(ref)}`)
      .then(res => {
        if (!res.ok) throw new Error(`Erro HTTP: ${res.status}`);
        return res.json();
      })
      .then(data => {
        if (data.creditos !== undefined) {
          const creditosElement = document.getElementById('creditos');
          if (creditosElement) {
            creditosElement.innerText = data.creditos;
          } else {
            console.error('Elemento com id="creditos" não encontrado');
          }
        } else if (data.erro) {
          alert('Erro: ' + data.erro);
        } else {
          console.error('Resposta inesperada:', data);
        }
      })
      .catch(err => {
        console.error('Erro ao buscar créditos:', err);
        alert('Erro ao conectar com o servidor');
      });
  </script>
</body>
</html>
